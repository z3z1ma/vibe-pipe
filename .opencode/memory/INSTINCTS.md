# INSTINCTS

This is the *fast index* of the current instinct set.
The source of truth is `.opencode/memory/instincts.json`.

<!-- BEGIN:compound:instincts-md -->
## Active instincts (top confidence)

- **nullable-schema-fields-for-tests** (95%)
  - Trigger: Creating test fixtures with DataRecord objects that have null values in specific fields
  - Action: Set nullable=True on SchemaField definitions for any field that may contain None in test data. DataRecord.__post_init__ raises ValueError if a non-nullable field contains None.
- **yaml-dev-deps-for-mypy** (95%)
  - Trigger: Adding YAML format support in strict MyPy project
  - Action: Install pyyaml runtime dependency and types-pyamal as dev dependency to satisfy strict type checking
- **retry-metrics-mutable-not-frozen** (95%)
  - Trigger: During retry decorator implementation, encountered mypy error when trying to update RetryMetrics fields. RetryMetrics was frozen=True which prevented field mutations during retry loop.
  - Action: Change RetryMetrics from @dataclass(frozen=True) to @dataclass to allow mutable updates during retry attempts. Fields like total_attempts, dlq_sent, and circuit_breaker_opened need to be updated.
- **sync-ticket-updates** (90%)
  - Trigger: After any `loom ticket` command that changes state (close, add-note, update)
  - Action: Run `loom ticket sync` to commit ticket changes to repository
- **phase3-ticket-sequencing** (90%)
  - Trigger: Starting Phase 3 ticket implementation
  - Action: Orchestration Engine (vp-cf95) must complete before CLI (vp-6cf1), Scheduling (vp-7d49), and Monitoring (vp-f17e) can fully integrate. Verify orchestration engine is in codebase before spawning worker…
- **optional-dependency-import-pattern** (90%)
  - Trigger: Need to use external library that may not be installed
  - Action: 1. Wrap import in try/except block 2. Add type: ignore[import-untyped] comment for mypy 3. Set flag variable to track availability 4. Provide fallback behavior when unavailable 5. Document degradation…
- **pandas-string-accessor-pattern** (90%)
  - Trigger: Applying string methods (trim, upper, lower, title) to pandas DataFrame columns
  - Action: Always use df[col].str.method() for column operations, never operate on individual strings. The Series.str accessor returns a StringMethods object that operates on the entire series efficiently.
- **export-new-transformation-modules** (90%)
  - Trigger: Creating new transformation modules (aggregations, cleaning, windows, etc.)
  - Action: Immediately update src/vibe_piper/transformations/__init__.py to include __all__ exports from the new module with descriptive docstring categories (e.g., # Cleaning, # Aggregations).
- **sklearn-max-samples-auto** (90%)
  - Trigger: Using sklearn.ensemble.IsolationForest
  - Action: Set max_samples='auto' instead of None (scikit-learn v1.5+ requires explicit value)
- **expectation-validationresult-return** (90%)
  - Trigger: Creating validation expectation for @validate decorator
  - Action: Ensure custom validation functions return ValidationResult(is_valid=..., errors=(...)) for compatibility with ValidationConfig.checks
- **optional-scipy-type-checking** (90%)
  - Trigger: importing scipy.stats for KS/PSI/chi-square tests
  - Action: import scipy inside function body with TYPE_CHECKING guard to prevent ImportError when scipy is not installed, keep import localized
- **two-pass-inheritance-parsing** (90%)
  - Trigger: Implementing environment inheritance
  - Action: Parse all environments first, then merge in second pass to handle forward references (child inherits from parent)
- **catch-as-exception-check-isinstance** (90%)
  - Trigger: Catching multiple parser exception types with MyPy strict mode
  - Action: Catch as Exception, then use isinstance() to distinguish specific parser errors vs generic IO errors
- **cloud-io-bucket-validation** (90%)
  - Trigger: Validating environment configuration
  - Action: When environment uses cloud IO manager (s3/gcs/azure), enforce that bucket parameter is provided
- **inst-20250129-001** (90%)
  - Trigger: validation_completed
  - Action: store_validation_result
- **retry-jitter-default-full** (90%)
  - Trigger: Implemented jitter strategies (NONE, FULL, EQUAL, DECORRELATED) in retry system. Observed that FULL jitter (random 0 to delay) provides best protection against thundering herd when multiple clients re…
  - Action: Set jitter_strategy=JitterStrategy.FULL as default in RetryConfig to prevent coordinated retry storms.
- **fastapi-middleware-stack** (90%)
  - Trigger: Creating new FastAPI application
  - Action: Add CORS middleware (allow_origins=['http://localhost:5173', 'http://localhost:3000']), GZipMiddleware(minimum_size=1000), RequestIDMiddleware (X-Request-ID header), RateLimitMiddleware (token bucket:…
- **tailwind-vite-setup** (90%)
  - Trigger: Setting up new React + Vite + Tailwind project
  - Action: Install @tailwindcss/postcss, configure postcss.config.js with '@tailwindcss/postcss' plugin, add @tailwind directives to src/index.css, configure tsconfig.json path aliases (@/* -> ./src/*), add path…
- **resolve-ai-managed-conflicts** (85%)
  - Trigger: Merge conflicts in AI-managed files (AGENTS.md, LOOM_ROADMAP.md, LOOM_PROJECT.md, CHANGELOG.md) when syncing merge-queue with origin/main
  - Action: Accept incoming version with --theirs since AI-managed blocks are auto-generated by other agents. Use: git checkout --theirs AGENTS.md LOOM_ROADMAP.md
- **verify-code-before-ticket-close** (85%)
  - Trigger: Worker marks ticket ready for review/merge
  - Action: Before closing ticket, use glob to verify expected code files exist in codebase (e.g., src/vibe_piper/connectors/*.py for database connector tickets). This prevents closing tickets where implementatio…
- **datetime-none-coalescing** (85%)
  - Trigger: Performing datetime arithmetic with potentially None fields
  - Action: Always use: (field or datetime.utcnow()) to ensure arithmetic operations have datetime, not Optional[datetime]
- **float-to-int-outlier-replacement** (85%)
  - Trigger: Replacing outliers with mean/median (always float) into integer columns
  - Action: Either use .astype(float) on the column before replacement to allow float values, or cast mean_val to int explicitly using int(mean_val) when the target column is integer type.
- **nullable-schema-test-fixture** (85%)
  - Trigger: Testing null handling in DataRecords
  - Action: Define SchemaField with nullable=True when fixture may contain None values to avoid DataRecord validation errors
- **optional-dependency-type-ignore** (85%)
  - Trigger: Importing sklearn or numpy with try/except for optional dependency
  - Action: Include '# type: ignore[import-untyped]' on import statement to satisfy mypy strict mode while allowing graceful degradation
- **drift-history-timestamp-tracking** (85%)
  - Trigger: implementing DriftHistory class for drift monitoring
  - Action: store each drift check with timestamp, baseline_id, method, drift_score, and alert_level to enable temporal trend analysis
- **statistical-test-min-samples** (85%)
  - Trigger: calling detect_drift_ks, detect_drift_psi, or detect_drift_chi_square
  - Action: check that both baseline and new data have at least min_samples (default 50) before running test, return DriftResult with error message if insufficient
- **check-worktree-before-sync** (85%)
  - Trigger: Attempting to merge origin/main into merge-queue branch
  - Action: Run git status first. If modified files exist, commit or stash them before attempting the sync. This prevents ff-only failures and merge conflicts.
- **multi-format-config-detection** (85%)
  - Trigger: Implementing multi-format configuration support
  - Action: When supporting multiple config formats (TOML/YAML/JSON), search for files in preference order rather than requiring explicit format parameter
- **runtime-override-merge-method** (85%)
  - Trigger: Implementing runtime configuration overrides
  - Action: Instead of modifying config in place, create a method that returns a new merged config with CLI overrides applied
- **cli-override-merge-logic** (85%)
  - Trigger: Applying runtime configuration overrides
  - Action: When applying CLI overrides, merge them with environment configs while preserving environment-specific values that aren't being overridden
- **circuit-breaker-configurable-thresholds** (85%)
  - Trigger: Implemented circuit breaker with configurable failure_threshold, success_threshold, timeout_seconds, and exception_types. This allows fine-tuning for different service characteristics and failure patt…
  - Action: Use CircuitBreakerConfig with sensible defaults (failure_threshold=5, success_threshold=2, timeout_seconds=60.0) to provide automatic protection while allowing customization for specific use cases.
- **fastapi-jwt-auth-pattern** (85%)
  - Trigger: Implementing FastAPI authentication
  - Action: Use python-jose for JWT tokens (access expires 30min, refresh 7 days), passlib[bcrypt] for password hashing, OAuth2PasswordBearer for token scheme, store refresh tokens for rotation, return structured…
- **react-api-service-layer** (85%)
  - Trigger: Building React app that talks to API
  - Action: Create src/services/api.ts with fetch wrapper, API_BASE_URL from env, headers with Authorization: Bearer token from localStorage, ApiError class with error/message/status fields, typed endpoints retur…
- **regenerate-uv-lock-corrupt** (85%)
  - Trigger: uv lock fails with 'missing source field but has more than one matching package' or TOML parse error
  - Action: Delete uv.lock and regenerate: rm uv.lock && uv lock. This resolves dependency resolution corruption from multiple branch merges.
- **check-loom-permissions-early** (80%)
  - Trigger: Acting as Team Manager for Loom team
  - Action: Verify permission rules allow `loom team *` commands early. If only `loom ticket *` is allowed, document blocker immediately and proceed with ticket-only workflow.
- **loom-manager-add-ticket-notes** (80%)
  - Trigger: Created new ticket via loom ticket create
  - Action: Immediately add a note to the ticket with: 1) Tasks numbered list, 2) Dependencies (if any), 3) Acceptance criteria, 4) Technical notes, 5) Example usage (if feature)
- **merge-worker-workspace-cleanup** (80%)
  - Trigger: Attempting to retire worker after merge
  - Action: When 'loom team retire <worker>' fails with 'modified or untracked files' error, check worktree status with git status and either: 1) Stash uncommitted changes, 2) Use --force flag if safe to delete, …
- **drift-baseline-storage-json** (80%)
  - Trigger: implementing drift detection with historical comparison
  - Action: save baseline data to JSON file with metadata (timestamp, sample_size, columns, schema_name) for efficient retrieval
- **validation-result-wrapper-pattern** (80%)
  - Trigger: creating check_drift_ks and check_drift_psi functions
  - Action: map drift detection results to ValidationResult: is_valid=(alert_level != 'critical'), errors=list for critical, warnings=list for recommendations and drifted columns
- **config-module-docstring-examples** (80%)
  - Trigger: Implementing configuration module
  - Action: Include examples of all supported formats, inheritance patterns, and runtime override usage in module-level docstring

## Notes

- Instincts are the *pre-skill* layer: small, repeatable heuristics.
- When an instinct proves useful across sessions, promote it into a Skill.
<!-- END:compound:instincts-md -->
