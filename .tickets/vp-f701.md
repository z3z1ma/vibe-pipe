---
"id": "vp-f701"
"status": "in_progress"
"deps": []
"links": []
"created": "2026-01-30T04:08:39Z"
"type": "feature"
"priority": 1
"assignee": "z3z1ma"
"tags":
- "phase1"
- "implementation"
- "schema"
"external": {}
---
# Implement Schema-First Mapping

Implement schema-first field mapping with source_path annotation to eliminate manual field extraction and type conversion code.

Based on investigation (vp-5299), Phase 1 needs:

Schema-First Mapping to implement:
1. **source_path field annotation** - Add to SchemaField:
   - Declare nested field paths (e.g., 'company.name', 'address.city')
   - Support array indexing (e.g., 'tags[0]')
   - Support mixed paths (e.g., 'data.items[0].name')

2. **Auto-mapping logic** - Extract values from source using source_path:
   - Parse dot notation: 'company.name' → obj['company']['name']
   - Parse bracket notation: 'tags[0]' → obj['tags'][0]
   - Parse mixed: 'data.items[0].name' → obj['data']['items'][0]['name']
   - Handle missing values gracefully (return None if path doesn't exist)
   - Support default values for missing paths

3. **Auto-type conversion** - Convert source values to schema types:
   - String → DateTime for DATETIME fields
   - String → Date for DATE fields
   - String → Integer for INTEGER fields
   - String → Float for FLOAT fields
   - String → Boolean for BOOLEAN fields
   - Handle null values (None for nullable fields, error for required fields)
   - Preserve timezone info for DATETIME

4. **Field mapper utility** - Apply mapping to entire record:
   - Takes: source_record, schema (with source_path annotations)
   - Returns: target_record with all fields mapped and type-converted
   - Validation against schema (required fields present, types correct)
   - Error collection for failed mappings/conversions

Expected files:
- src/vibe_piper/schema/__init__.py (update exports)
- src/vibe_piper/schema/mapping.py (auto-mapping logic)
- src/vibe_piper/schema/field_mapper.py (field mapper utility)
- tests/schema/test_mapping.py
- tests/schema/test_field_mapper.py

Integration:
- Extends existing: SchemaField (add source_path attribute)
- Uses existing: DataType, Schema, SchemaField
- Works with: Source/Sink abstractions (when implemented)
- Works with: @asset decorator for pipeline integration

Acceptance Criteria:
- SchemaField supports source_path annotation
- Auto-mapping extracts 'company.name' → obj['company']['name']
- Auto-mapping extracts 'address.city' → obj['address']['city']
- Auto-mapping handles missing paths (returns None, logs warning)
- Auto-type conversion string → DateTime working
- Auto-type conversion string → Integer working with error on invalid
- Required field validation working (error if missing)
- Nullable field handling working (None allowed)
- Comprehensive tests (80%+ coverage)
- Documentation for source_path syntax

Success Metrics (from investigation):
- Code reduction: 90%+ for field mapping (from 25+ lines to 0)
- Manual field extraction: 0 lines
- Manual type conversion: 0 lines
- Clear intent: source_path in schema vs manual if/else

Reference:
- Original manual code in examples/api_ingestion/pipeline.py lines 39-64 (to_database_dict)
- Investigator design in docs/investigation_missing_abstractions.md section 2.1.B
